<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novyra AI - Advanced Admin Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’¬</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Primary Colors - Professional Deep Blue */
            --primary: #25D366;
            --primary-dark: #20BA5A;
            --primary-light: #128C7E;
            --secondary: #CFB53B;
            --accent: #34B7F1;
            
            /* Status Colors - Accessible */
            --success: #25D366;
            --success-light: #20BA5A;
            --warning: #F59E0B;
            --warning-light: #FBBF24;
            --danger: #DC2626;
            --danger-light: #EF4444;
            --info: #34B7F1;
            --info-light: #53BDEB;
            
            /* Neutral Colors - WhatsApp Light Mode */
            --dark: #000000;
            --dark-medium: #54656F;
            --gray: #667781;
            --gray-light: #8696A0;
            --gray-lighter: #E9EDEF;
            --light: #F0F2F5;
            --white: #FFFFFF;
            
            /* Background Colors - WhatsApp Light Mode */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F0F2F5;
            --bg-tertiary: #E9EDEF;
            --bg-quaternary: #F5F6F6;
            
            /* Text Colors - High Contrast */
            --text-primary: #111B21;
            --text-secondary: #54656F;
            --text-tertiary: #667781;
            --text-inverse: #FFFFFF;
            
            /* Border Colors - WhatsApp Style */
            --border-light: rgba(0, 0, 0, 0.08);
            --border-medium: rgba(0, 0, 0, 0.12);
            --border-dark: rgba(0, 0, 0, 0.2);
            
            /* Layout */
            --sidebar-width: 280px;
            --header-height: 70px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.12);
            --radius: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* WhatsApp-style light mode base styles */
        body.light-mode {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F0F2F5;
            --bg-tertiary: #E9EDEF;
            --text-primary: #111B21;
            --text-secondary: #54656F;
            --text-tertiary: #667781;
            --border-light: rgba(0, 0, 0, 0.08);
            --border-medium: rgba(0, 0, 0, 0.12);
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles - WhatsApp Light Mode */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-primary);
            border-right: none;
            color: var(--text-primary);
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: none;
            z-index: 100;
            transition: var(--transition);
            transform: translateX(0);
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--gray);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 12px 16px;
            margin-bottom: 0;
            border-bottom: none;
            background: var(--bg-quaternary);
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        body.light-mode .sidebar-header {
            background: var(--bg-quaternary);
            border-bottom: none;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .logo:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.5px;
        }

        .sidebar-header p {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 400;
            margin: 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 5px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0;
            margin: 0;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            font-weight: 500;
            font-size: 14px;
            border: none;
            border-left: 3px solid transparent;
        }
        
        body.light-mode .sidebar-nav a {
            border-radius: 0;
            border-left: 3px solid transparent;
        }

        .sidebar-nav a:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        body.light-mode .sidebar-nav a:hover {
            background: var(--bg-secondary);
        }

        .sidebar-nav a.active {
            background: var(--bg-secondary);
            color: var(--primary);
            border-left-color: var(--primary);
            font-weight: 600;
        }
        
        body.light-mode .sidebar-nav a.active {
            background: var(--bg-secondary);
            border-left-color: var(--primary);
            color: var(--primary);
        }
        
        body.dark-mode .sidebar-nav a.active {
            background: rgba(32, 44, 51, 0.9);
            border-left-color: var(--primary);
            color: var(--primary);
        }
        
        .sidebar-nav a.active i {
            color: var(--primary);
        }

        .sidebar-nav i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 30px;
            background: transparent;
            transition: var(--transition);
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px 24px;
            background: var(--bg-primary);
            border-radius: 0;
            border: none;
            box-shadow: none;
            border-bottom: 1px solid var(--border-light);
        }
        
        body.dark-mode .dashboard-header {
            background: rgba(32, 44, 51, 0.95);
            border-bottom: 1px solid rgba(134, 150, 160, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        body.light-mode .dashboard-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            border-radius: 0;
            box-shadow: none;
        }

        .dashboard-header h2 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        body.light-mode .dashboard-header h2 {
            color: var(--text-primary);
        }

        .dashboard-header p {
            color: var(--text-tertiary);
            font-size: 15px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 18px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 255, 0.98) 100%);
            border-radius: 50px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .user-profile:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            box-shadow: var(--shadow);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 255, 0.98) 100%);
            padding: 28px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease-out;
        }
        
        body.dark-mode .stat-card {
            background: rgba(32, 44, 51, 0.95);
            border: 1px solid rgba(134, 150, 160, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .stat-card:hover {
            background: rgba(32, 44, 51, 1);
            border-color: rgba(134, 150, 160, 0.25);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow);
            border-color: rgba(207, 181, 59, 0.4);
        }

        .stat-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }

        .stat-card.primary:before { background: var(--primary); }
        .stat-card.success:before { background: var(--secondary); }
        .stat-card.warning:before { background: var(--secondary); }
        .stat-card.danger:before { background: var(--danger); }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-card-title {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .stat-card.primary .stat-card-icon { background: var(--primary); }
        .stat-card.success .stat-card-icon { background: var(--secondary); }
        .stat-card.warning .stat-card-icon { background: var(--secondary); }
        .stat-card.danger .stat-card-icon { background: var(--danger); }

        .stat-card-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-card-change {
            font-size: 13px;
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .stat-card-change.negative {
            color: var(--danger);
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 255, 0.98) 100%);
            padding: 28px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s ease-out;
        }
        
        body.dark-mode .chart-card {
            background: rgba(32, 44, 51, 0.95);
            border: 1px solid rgba(134, 150, 160, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .chart-card:hover {
            background: rgba(32, 44, 51, 1);
            border-color: rgba(134, 150, 160, 0.25);
        }

        .chart-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: rgba(207, 181, 59, 0.4);
        }

        .chart-card h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chart-card h3 i {
            color: var(--secondary);
        }

        /* Table Styles */
        .table-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 255, 0.98) 100%);
            padding: 28px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
            margin-bottom: 30px;
            animation: fadeInUp 0.7s ease-out;
        }
        
        body.dark-mode .table-card {
            background: rgba(32, 44, 51, 0.95);
            border: 1px solid rgba(134, 150, 160, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .table-card h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-card h3 i {
            color: var(--secondary);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 6, 177, 0.1);
            color: var(--text-primary);
        }

        .table th {
            font-weight: 700;
            color: var(--white);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background: linear-gradient(90deg, rgba(0, 6, 177, 0.05) 0%, rgba(207, 181, 59, 0.05) 100%);
            transform: translateX(4px);
            box-shadow: -4px 0 0 rgba(207, 181, 59, 0.3);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: var(--radius-lg);
            font-size: 12px;
            font-weight: 600;
        }

        .status-active { background: var(--secondary); color: var(--dark); border: 1px solid var(--dark); }
        .status-waiting { background: var(--secondary); color: var(--dark); border: 1px solid var(--dark); }
        .status-assigned { background: var(--primary); color: white; border: 1px solid var(--dark); }
        .status-resolved { background: var(--secondary); color: var(--dark); border: 1px solid var(--dark); }
        .status-closed { background: var(--dark); color: white; border: 1px solid var(--secondary); }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(207, 181, 59, 0.4), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-light);
            color: var(--primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-outline:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 6, 177, 0.2);
        }

        .refresh-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 700;
            margin-bottom: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .refresh-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(207, 181, 59, 0.4), transparent);
            transition: left 0.5s;
        }

        .refresh-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .refresh-button:hover::before {
            left: 100%;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--accent);
        }

        /* Live Chat Styles */
        .live-chat-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .sessions-list {
            background: var(--bg-primary);
            border-radius: 0;
            box-shadow: none;
            border: none;
            border-right: 1px solid var(--border-light);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: fadeInLeft 0.3s ease-out;
        }
        
        body.dark-mode .sessions-list {
            background: rgba(17, 27, 33, 0.95);
            border-right: 1px solid rgba(134, 150, 160, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        body.light-mode .sessions-list {
            background: var(--bg-primary);
            border-right: 1px solid var(--border-light);
            border-radius: 0;
        }

        .sessions-list-header {
            padding: 12px 16px;
            background: var(--bg-quaternary);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        body.light-mode .sessions-list-header {
            background: var(--bg-quaternary);
            border-bottom: none;
        }
        
        .sessions-list-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sessions-list-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        body.light-mode .sessions-list-body {
            padding: 0;
        }

        .session-item {
            padding: 12px 16px;
            margin-bottom: 0;
            background: var(--bg-primary);
            border-radius: 0;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            border-bottom: 1px solid var(--border-light);
            animation: fadeIn 0.2s;
            color: var(--text-primary);
        }
        
        body.dark-mode .session-item {
            background: rgba(32, 44, 51, 0.6);
            border-bottom: 1px solid rgba(134, 150, 160, 0.15);
        }
        
        body.dark-mode .session-item:hover {
            background: rgba(32, 44, 51, 0.9);
            border-bottom-color: rgba(134, 150, 160, 0.25);
        }
        
        body.light-mode .session-item {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            border-radius: 0;
        }

        .session-item:hover {
            background: var(--bg-secondary);
            transform: none;
            border-bottom-color: var(--border-light);
            box-shadow: none;
        }
        
        body.light-mode .session-item:hover {
            background: var(--bg-secondary);
        }

        .session-item.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-color: var(--border-light);
            box-shadow: none;
            border-left: 3px solid var(--primary);
        }
        
        body.light-mode .session-item.active {
            background: var(--bg-secondary);
            border-left: 3px solid var(--primary);
        }
        
        body.dark-mode .session-item.active {
            background: rgba(32, 44, 51, 0.9);
            color: #E9EDEF;
            border-left: 3px solid var(--primary);
        }
        
        .session-item.active .session-item-id,
        .session-item.active .session-item-time,
        .session-item.active .session-item-preview {
            color: var(--text-primary);
        }
        
        body.light-mode .session-item.active .session-item-id,
        body.light-mode .session-item.active .session-item-time,
        body.light-mode .session-item.active .session-item-preview {
            color: var(--text-primary);
        }
        
        body.dark-mode .session-item.active .session-item-id,
        body.dark-mode .session-item.active .session-item-time,
        body.dark-mode .session-item.active .session-item-preview {
            color: #E9EDEF;
        }

        .session-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .session-item-id {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
        }

        .session-item-time {
            font-size: 11px;
            color: var(--accent);
        }

        .session-item-preview {
            font-size: 12px;
            color: var(--accent);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .session-item-badge {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-window {
            background: var(--bg-primary);
            border-radius: 0;
            box-shadow: none;
            border: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: fadeInRight 0.3s ease-out;
        }
        
        body.dark-mode .chat-window {
            background: rgba(17, 27, 33, 0.95);
            border: 1px solid rgba(134, 150, 160, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        body.light-mode .chat-window {
            background: var(--bg-primary);
            border: none;
            box-shadow: none;
        }

        .chat-window-header {
            padding: 12px 16px;
            background: var(--bg-quaternary);
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
            border-radius: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        body.light-mode .chat-window-header {
            background: var(--bg-quaternary);
            border-bottom: none;
        }

        .chat-window-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .chat-window-header-info {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-secondary);
            border: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        body.dark-mode .chat-messages-container {
            background: rgba(11, 20, 26, 0.95);
        }
        
        body.light-mode .chat-messages-container {
            background: var(--bg-secondary);
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 20px,
                    rgba(0, 0, 0, 0.02) 20px,
                    rgba(0, 0, 0, 0.02) 21px
                );
        }

        .chat-message {
            margin-bottom: 8px;
            display: flex;
            animation: fadeInUp 0.2s;
        }
        
        body.light-mode .chat-message {
            margin-bottom: 8px;
        }

        .chat-message.user {
            justify-content: flex-end;
        }

        .chat-message.agent {
            justify-content: flex-start;
        }

        .chat-message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .chat-message.user .chat-message-content {
            background: #D9FDD3;
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-lg);
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        body.dark-mode .chat-message.user .chat-message-content {
            background: #005C4B;
            color: #E9EDEF;
        }
        
        body.light-mode .chat-message.user .chat-message-content {
            background: #D9FDD3;
            color: var(--text-primary);
        }

        .chat-message.agent .chat-message-content {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-lg);
            border-bottom-left-radius: 4px;
            font-weight: 400;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        body.dark-mode .chat-message.agent .chat-message-content {
            background: rgba(32, 44, 51, 0.95);
            color: #E9EDEF;
            border: 1px solid rgba(134, 150, 160, 0.25);
        }
        
        body.light-mode .chat-message.agent .chat-message-content {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
        }
        
        .chat-message.ai .chat-message-content {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-lg);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        body.dark-mode .chat-message.ai .chat-message-content {
            background: rgba(32, 44, 51, 0.95);
            color: #E9EDEF;
            border: 1px solid rgba(134, 150, 160, 0.25);
        }
        
        body.light-mode .chat-message.ai .chat-message-content {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
        }
        
        .chat-message-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
            opacity: 0.9;
            text-transform: capitalize;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-message-sender-profile {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-light);
        }
        
        .chat-message.user .chat-message-sender {
            text-align: right;
            justify-content: flex-end;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .chat-message.agent .chat-message-sender {
            text-align: left;
            justify-content: flex-start;
            color: var(--text-primary);
        }
        
        .chat-message.ai .chat-message-sender {
            text-align: left;
            justify-content: flex-start;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Seen indicator with profile picture (Facebook-style) */
        .chat-message-seen {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            font-size: 10px;
            opacity: 0.7;
            justify-content: flex-end;
        }
        
        .chat-message.agent .chat-message-seen,
        .chat-message.ai .chat-message-seen {
            justify-content: flex-start;
        }
        
        .chat-message-seen-label {
            font-size: 10px;
            color: var(--text-tertiary);
        }
        
        .chat-message-seen-profile {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border-light);
        }
        
        /* Voice message wave animation */
        .voice-wave-container {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-left: 8px;
        }
        
        .voice-wave {
            width: 3px;
            height: 16px;
            background: currentColor;
            border-radius: 2px;
            animation: wave 1.2s ease-in-out infinite;
            opacity: 0.6;
        }
        
        .voice-wave:nth-child(2) {
            animation-delay: 0.1s;
        }
        
        .voice-wave:nth-child(3) {
            animation-delay: 0.2s;
        }
        
        .voice-wave:nth-child(4) {
            animation-delay: 0.3s;
        }
        
        .voice-wave:nth-child(5) {
            animation-delay: 0.4s;
        }
        
        @keyframes wave {
            0%, 100% {
                transform: scaleY(0.5);
                opacity: 0.4;
            }
            50% {
                transform: scaleY(1);
                opacity: 0.8;
            }
        }
        
        .voice-message-preview.playing .voice-wave {
            animation-play-state: running;
        }
        
        .voice-message-preview:not(.playing) .voice-wave {
            animation-play-state: paused;
        }

        .chat-message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
            color: var(--text-tertiary);
        }

        .chat-message.agent .chat-message-time,
        .chat-message.ai .chat-message-time {
            text-align: left;
        }
        
        /* Delete message button */
        .chat-message-delete {
            display: none;
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 10px;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .chat-message-content:hover .chat-message-delete {
            display: flex;
            opacity: 1;
        }
        
        .chat-message-delete:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.1);
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 18px;
            border: 1px solid var(--border-light);
            max-width: 70px;
            margin-bottom: 15px;
        }

        .typing-indicator.active {
            display: flex;
            gap: 5px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--secondary);
            border: 1px solid var(--dark);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .chat-input-area {
            padding: 12px 16px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-light);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .chat-input-form {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chat-input-field {
            flex: 1;
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
            transition: var(--transition);
            min-height: 40px;
            max-height: 120px;
            resize: none;
            font-family: inherit;
            line-height: 1.4;
        }

        .chat-input-field::placeholder {
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .chat-input-field:focus {
            background: var(--bg-primary);
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }

        .chat-send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }

        .chat-send-button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .chat-send-button:active {
            transform: scale(0.95);
        }

        .chat-send-button:disabled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.6;
        }

        .no-session-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--accent);
            font-size: 16px;
            flex-direction: column;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--accent);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLeft {
            from { 
                opacity: 0;
                transform: translateX(-20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from { 
                opacity: 0;
                transform: translateX(20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Mobile Responsiveness */
        .mobile-header {
            display: none;
            padding: 18px 20px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 255, 0.98) 100%);
            border-bottom: 1px solid rgba(0, 6, 177, 0.15);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 99;
            align-items: center;
            justify-content: space-between;
        }

        .menu-toggle {
            width: 44px;
            height: 44px;
            border-radius: var(--radius);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 255, 0.98) 100%);
            border: 1px solid var(--border-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
        }
        
        .menu-toggle:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        @media (max-width: 1024px) {
            .live-chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sessions-list {
                height: 300px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-header {
                display: flex;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                display: none;
            }
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: 2px solid #CFB53B;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-bell:hover {
            background: #CFB53B;
            border-color: var(--accent);
            color: var(--text-primary);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(207, 181, 59, 0.3);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        .notification-dropdown {
            position: absolute;
            top: 55px;
            right: 0;
            width: 380px;
            max-height: 500px;
            background: var(--bg-primary);
            border-radius: var(--radius);
            border: 2px solid #CFB53B;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: none;
            overflow-y: auto;
        }

        .notification-dropdown.active {
            display: block;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid rgba(207, 181, 59, 0.3);
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .notification-item:hover {
            background: rgba(207, 181, 59, 0.1);
        }

        .notification-item.unread {
            background: rgba(207, 181, 59, 0.15);
            border-left: 3px solid var(--secondary);
        }

        .notification-item-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .notification-item-message {
            font-size: 13px;
            color: var(--accent);
        }

        .notification-item-time {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 5px;
        }

        .user-profile-dropdown {
            position: absolute;
            top: 55px;
            right: 0;
            width: 280px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 255, 0.98) 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
            padding: 12px;
        }

        .user-profile-dropdown.active {
            display: block;
        }

        .user-profile-dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .user-profile-dropdown-item:hover {
            background: linear-gradient(135deg, rgba(0, 6, 177, 0.1) 0%, rgba(207, 181, 59, 0.15) 100%);
            border: 1px solid var(--border-light);
            transform: translateX(4px);
            box-shadow: -4px 0 0 rgba(207, 181, 59, 0.3);
        }

        /* Profile Section Styles */
        .profile-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .profile-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 255, 0.98) 100%);
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
        }

        .profile-picture-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--dark);
            box-shadow: 0 0 0 4px var(--secondary);
            margin: 0 auto 15px;
            display: block;
        }

        .profile-picture-upload {
            display: none;
        }

        .profile-picture-label {
            display: inline-block;
            padding: 8px 16px;
            background: var(--secondary);
            color: var(--dark);
            border: 2px solid var(--dark);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .profile-picture-label:hover {
            background: var(--dark);
            color: var(--secondary);
        }

        .profile-form-group {
            margin-bottom: 20px;
        }

        .profile-form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-form-input {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            font-size: 15px;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 6, 177, 0.15), 
                        0 4px 12px rgba(0, 6, 177, 0.2);
            transform: translateY(-1px);
        }

        .login-history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .login-history-table th,
        .login-history-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 6, 177, 0.1);
            color: var(--text-primary);
        }

        .login-history-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            font-weight: 700;
            border: none;
        }

        /* Enhanced File Display */
        .attachment-container {
            margin-top: 12px;
            padding: 14px;
            background: linear-gradient(135deg, rgba(0, 6, 177, 0.05) 0%, rgba(207, 181, 59, 0.08) 100%);
            border-radius: 14px;
            border: 1px solid var(--border-light);
        }

        .attachment-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .attachment-image:hover {
            transform: scale(1.02);
        }

        .attachment-document {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 255, 0.95) 100%);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
        }

        .attachment-document:hover {
            background: linear-gradient(135deg, rgba(0, 6, 177, 0.1) 0%, rgba(207, 181, 59, 0.15) 100%);
            border-color: var(--primary);
            transform: translateX(6px);
            box-shadow: var(--shadow);
        }

        .attachment-icon {
            font-size: 24px;
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 255, 0.98) 100%);
            border: 1px solid var(--border-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-toggle:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow);
        }

        /* Progress Bars */
        .progress-bar {
            height: 6px;
            background: var(--gray-light);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .progress-primary { background: var(--primary); }
        .progress-success { background: var(--success); }
        .progress-warning { background: var(--warning); }
        .progress-danger { background: var(--danger); }
    </style>
</head>
<body>
    <div class="mobile-header">
        <div class="menu-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </div>
        <div class="logo">ðŸ“Š</div>
        <div class="user-profile">
            <div class="user-avatar">A</div>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">ðŸ“Š</div>
                <div>
                    <h1>Novyra AI</h1>
                    <p>Admin Dashboard</p>
                </div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="#" class="active" onclick="showSection('overview', this)"><i class="fas fa-chart-line"></i> Overview</a></li>
                <li><a href="#" onclick="showSection('livechat', this)"><i class="fas fa-comments"></i> Live Chat</a></li>
                <li><a href="#" onclick="showSection('agentchat', this)"><i class="fas fa-user-friends"></i> Agent Chat</a></li>
                <li><a href="#" onclick="showSection('sessions', this)"><i class="fas fa-list"></i> Sessions</a></li>
                <li><a href="#" onclick="showSection('agents', this)"><i class="fas fa-users"></i> Agents</a></li>
                <li><a href="#" onclick="showSection('analytics', this)"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                <li><a href="#" onclick="showSection('embed', this)"><i class="fas fa-code"></i> Embed Widget</a></li>
                <li><a href="#" onclick="showSection('profile', this)"><i class="fas fa-user-circle"></i> Profile</a></li>
                <li style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(207, 181, 59, 0.3);"><a href="/admin/" target="_blank"><i class="fas fa-cog"></i> Django Admin</a></li>
                <li><a href="/" target="_blank"><i class="fas fa-robot"></i> Test Chat</a></li>
                <li style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(207, 181, 59, 0.3);"><a href="/logout/" onclick="return confirm('Are you sure you want to logout?')"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <div class="main-content" id="mainContent">
            <div class="dashboard-header">
                <div>
                    <h2 id="pageTitle">Dashboard Overview</h2>
                    <p id="pageSubtitle">Monitor your AI chat assistant performance in real-time</p>
                </div>
                <div class="header-actions">
                    <div class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                    </div>
                    <div class="notification-bell" onclick="toggleNotifications()" style="position: relative;">
                        <i class="fas fa-bell"></i>
                        <div class="notification-badge" id="notificationBadge">0</div>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div style="padding: 15px; border-bottom: 1px solid var(--gray-light); font-weight: 600;">
                                Notifications
                            </div>
                            <div id="notificationList">
                                <div style="padding: 20px; text-align: center; color: var(--gray);">
                                    No notifications
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile" onclick="toggleUserDropdown()" style="position: relative; cursor: pointer;">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div>
                            <div style="font-weight: 600;" id="userName">Admin User</div>
                            <div style="font-size: 12px; color: var(--gray);" id="userRole">Administrator</div>
                        </div>
                        <div class="user-profile-dropdown" id="userDropdown">
                            <div class="user-profile-dropdown-item" onclick="showSection('profile', null)">
                                <i class="fas fa-user"></i> Profile Settings
                            </div>
                            <div class="user-profile-dropdown-item" onclick="window.location.href='/logout/'">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="refresh-button" onclick="loadDashboard()">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>

            <div id="overviewSection">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Total Sessions</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="totalSessions">1,247</div>
                        <div class="stat-card-change">
                            <i class="fas fa-arrow-up"></i> 12.5% from last week
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-primary" style="width: 75%"></div>
                        </div>
                    </div>

                    <div class="stat-card success">
                        <div class="stat-card-header">
                            <span class="stat-card-title">AI Resolved</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="aiResolved">892</div>
                        <div class="stat-card-change">
                            <i class="fas fa-arrow-up"></i> 8.3% from last week
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-success" style="width: 72%"></div>
                        </div>
                    </div>

                    <div class="stat-card warning">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Escalations</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="escalations">187</div>
                        <div class="stat-card-change negative">
                            <i class="fas fa-arrow-down"></i> 5.2% from last week
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-warning" style="width: 15%"></div>
                        </div>
                    </div>

                    <div class="stat-card danger">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Avg Rating</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="avgRating">4.7</div>
                        <div class="stat-card-change">
                            <i class="fas fa-arrow-up"></i> 0.3 from last month
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-danger" style="width: 94%"></div>
                        </div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3><i class="fas fa-chart-pie"></i> Session Status Distribution</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3><i class="fas fa-chart-line"></i> Daily Activity</h3>
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3><i class="fas fa-clock"></i> Response Times</h3>
                        <canvas id="responseTimeChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3><i class="fas fa-user-check"></i> Agent Performance</h3>
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="sessionsSection" style="display: none;">
                <div class="table-card">
                    <h3><i class="fas fa-list"></i> Recent Chat Sessions</h3>
                    <div class="loading" id="sessionsLoading">Loading sessions...</div>
                    <table class="table" id="sessionsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Status</th>
                                <th>Agent</th>
                                <th>Messages</th>
                                <th>Created</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="agentsSection" style="display: none;">
                <div class="table-card">
                    <h3><i class="fas fa-users"></i> Agents</h3>
                    <div class="loading" id="agentsLoading">Loading agents...</div>
                    <table class="table" id="agentsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Current Chats</th>
                                <th>Total Handled</th>
                                <th>Avg Rating</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="analyticsSection" style="display: none;">
                <div class="table-card">
                    <h3><i class="fas fa-chart-bar"></i> Detailed Analytics</h3>
                    <div id="analyticsContent">
                        <p>Analytics data will be displayed here.</p>
                    </div>
                </div>
            </div>

            <div id="embedSection" style="display: none;">
                <div class="dashboard-header">
                    <div>
                        <h2><i class="fas fa-code"></i> Bot Configuration & Embed Widget</h2>
                        <p>Configure your bot and generate embed code to add the chat widget to your website</p>
                    </div>
                </div>
                
                <div class="table-card" style="margin-top: 20px;">
                    <h3><i class="fas fa-robot"></i> Bot Configuration</h3>
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Bot Name</label>
                            <input type="text" id="botName" class="profile-form-input" placeholder="Ariho" value="Ariho">
                            <p style="margin-top: 5px; font-size: 12px; color: #666;">This is the name that will be displayed in the chat interface</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Bot Profile Image</label>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="width: 100px; height: 100px; border: 2px solid #0006B1; border-radius: 50%; overflow: hidden; background: var(--bg-primary); display: flex; align-items: center; justify-content: center;">
                                    <img id="botProfileImagePreview" src="" alt="Bot Profile" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <i class="fas fa-robot" id="botProfileImagePlaceholder" style="font-size: 40px; color: var(--primary);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <input type="file" id="botProfileImageInput" accept="image/*" style="display: none;" onchange="handleBotProfileImageChange(event)">
                                    <button type="button" class="btn btn-outline" onclick="document.getElementById('botProfileImageInput').click()" style="margin-bottom: 10px;">
                                        <i class="fas fa-upload"></i> Upload Image
                                    </button>
                                    <button type="button" class="btn btn-outline" onclick="removeBotProfileImage()" style="margin-left: 10px; background: var(--bg-primary); color: var(--primary); border-color: var(--primary);">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                    <p style="margin-top: 5px; font-size: 12px; color: #666;">Recommended: 200x200px, Square image</p>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveBotConfig()" style="width: 100%; margin-bottom: 20px;">
                            <i class="fas fa-save"></i> Save Bot Configuration
                        </button>
                    </div>
                </div>
                
                <div class="table-card" style="margin-top: 20px;">
                    <h3><i class="fas fa-cog"></i> Widget Configuration</h3>
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Widget Name</label>
                            <input type="text" id="widgetName" class="profile-form-input" placeholder="My Chat Widget" value="Default Widget">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Button Color</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="color" id="widgetButtonColor" value="#0006B1" style="width: 80px; height: 40px; border: 2px solid #CFB53B; border-radius: 8px; cursor: pointer;">
                                <input type="text" id="widgetButtonColorText" value="#0006B1" class="profile-form-input" style="flex: 1;" placeholder="#0006B1">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Button Position</label>
                            <select id="widgetPosition" class="profile-form-input">
                                <option value="bottom-right">Bottom Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="top-right">Top Right</option>
                                <option value="top-left">Top Left</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Widget Width (px)</label>
                                <input type="number" id="widgetWidth" class="profile-form-input" value="420" min="300" max="800">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Widget Height (px)</label>
                                <input type="number" id="widgetHeight" class="profile-form-input" value="600" min="400" max="800">
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="generateEmbedCode()" style="width: 100%;">
                            <i class="fas fa-code"></i> Generate Embed Code
                        </button>
                    </div>
                </div>
                
                <div class="table-card" id="embedCodeCard" style="margin-top: 20px; display: none;">
                    <h3><i class="fas fa-copy"></i> Embed Code</h3>
                    <div style="padding: 20px;">
                        <p style="margin-bottom: 10px; color: #666; font-weight: 600; font-size: 15px;">âœ… Working Embed Code</p>
                        <p style="margin-bottom: 15px; color: #666; font-size: 14px;">Copy and paste this code into your website's HTML, just before the closing &lt;/body&gt; tag. The widget will appear as a floating button on your website.</p>
                        <div style="position: relative;">
                            <textarea id="embedCodeTextarea" readonly style="width: 100%; min-height: 200px; padding: 15px; padding-right: 120px; border: 2px solid #CFB53B; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; background: #f8f9fa; color: var(--text-primary); resize: vertical; line-height: 1.6;"></textarea>
                            <button onclick="copyEmbedCode()" class="btn btn-primary" style="position: absolute; top: 10px; right: 10px; padding: 8px 16px; z-index: 10;">
                                <i class="fas fa-copy"></i> Copy Code
                            </button>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                            <p style="margin: 0 0 10px 0; font-size: 14px; color: #2e7d32; font-weight: 600;"><strong>ðŸ“Œ How to Use:</strong></p>
                            <ol style="margin: 0 0 0 20px; padding: 0; font-size: 13px; color: #2e7d32; line-height: 1.8;">
                                <li>Copy the embed code above</li>
                                <li>Paste it before the closing &lt;/body&gt; tag in your website's HTML</li>
                                <li>The chat button will appear as a floating button on your website</li>
                                <li>When clicked, it opens the full chat interface with all features</li>
                                <li>Users can chat with the bot or connect to live agents</li>
                            </ol>
                        </div>
                        <div id="embedWarning" style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; display: none;">
                            <p style="margin: 0 0 10px 0; font-size: 14px; color: #856404; font-weight: 600;"><strong>âš ï¸ Warning:</strong></p>
                            <p style="margin: 0 0 10px 0; font-size: 13px; color: #856404;">The embed code is using localhost (127.0.0.1). This will <strong>NOT work</strong> on external websites!</p>
                            <p style="margin: 0 0 10px 0; font-size: 13px; color: #856404; font-weight: 600;"><strong>To fix this:</strong></p>
                            <ol style="margin: 0 0 10px 20px; padding: 0; font-size: 13px; color: #856404; line-height: 1.8;">
                                <li>Open your <code>.env</code> file</li>
                                <li>Add: <code>EMBED_BASE_URL=https://yourdomain.com</code> (replace with your actual domain)</li>
                                <li>Restart your Django server</li>
                                <li>Regenerate the embed code</li>
                            </ol>
                            <p style="margin: 0; font-size: 12px; color: #856404; font-style: italic;">Example: <code>EMBED_BASE_URL=https://chat.novyra.com</code></p>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #0006B1;">
                            <p style="margin: 0; font-size: 13px; color: #1e40af;"><strong>ðŸ’¡ Note:</strong> The widget works on any website. Make sure your website allows iframes if you encounter any issues.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="profileSection" style="display: none;">
                <div class="dashboard-header">
                    <div>
                        <h2>Profile Settings</h2>
                        <p>Manage your profile, security, and login history</p>
                    </div>
                </div>
                <div class="profile-container">
                    <div class="profile-card">
                        <div class="profile-picture-container">
                            <img src="" alt="Profile Picture" class="profile-picture" id="profilePictureImg" onerror="this.style.display='none'; document.getElementById('profilePicturePlaceholder').style.display='flex';">
                            <div class="user-avatar" id="profilePicturePlaceholder" style="width: 150px; height: 150px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 60px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-radius: 50%;"></div>
                            <input type="file" id="profilePictureInput" class="profile-picture-upload" accept="image/*">
                            <label for="profilePictureInput" class="profile-picture-label">
                                <i class="fas fa-camera"></i> Change Picture
                            </label>
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">First Name</label>
                            <input type="text" class="profile-form-input" id="firstNameInput" placeholder="First Name">
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Last Name</label>
                            <input type="text" class="profile-form-input" id="lastNameInput" placeholder="Last Name">
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Email</label>
                            <input type="email" class="profile-form-input" id="emailInput" placeholder="Email">
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Phone Number</label>
                            <input type="text" class="profile-form-input" id="phoneInput" placeholder="Phone Number">
                        </div>
                        <div class="profile-form-group">
                            <label class="profile-form-label">Bio</label>
                            <textarea class="profile-form-input" id="bioInput" rows="3" placeholder="Bio"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="updateProfile()" style="width: 100%;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                    <div>
                        <div class="profile-card">
                            <h3 style="margin-bottom: 20px;"><i class="fas fa-lock"></i> Change Password</h3>
                            <div class="profile-form-group">
                                <label class="profile-form-label">Current Password</label>
                                <input type="password" class="profile-form-input" id="currentPasswordInput" placeholder="Current Password">
                            </div>
                            <div class="profile-form-group">
                                <label class="profile-form-label">New Password</label>
                                <input type="password" class="profile-form-input" id="newPasswordInput" placeholder="New Password">
                            </div>
                            <div class="profile-form-group">
                                <label class="profile-form-label">Confirm New Password</label>
                                <input type="password" class="profile-form-input" id="confirmPasswordInput" placeholder="Confirm New Password">
                            </div>
                            <button class="btn btn-primary" onclick="changePassword()" style="width: 100%;">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                        <div class="profile-card" style="margin-top: 20px;">
                            <h3 style="margin-bottom: 20px;"><i class="fas fa-history"></i> Login History</h3>
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table class="login-history-table">
                                    <thead>
                                        <tr>
                                            <th>Date & Time</th>
                                            <th>IP Address</th>
                                            <th>Device</th>
                                            <th>Browser</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loginHistoryBody">
                                        <tr>
                                            <td colspan="4" style="text-align: center; padding: 20px; color: var(--gray);">
                                                Loading login history...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="livechatSection" style="display: none;">
                <div class="dashboard-header">
                    <div>
                        <h2>Live Chat</h2>
                        <p>Chat with customers in real-time</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-outline">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary">
                            <i class="fas fa-plus"></i> New Session
                        </button>
                    </div>
                </div>
                <div class="live-chat-container">
                    <div class="sessions-list">
                        <div class="sessions-list-header">
                            Active Sessions
                            <button class="refresh-button" onclick="loadActiveSessions()" style="margin: 0; padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="sessions-list-body" id="sessionsListBody">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-comments"></i></div>
                                <p>No active sessions</p>
                            </div>
                        </div>
                    </div>
                    <div class="chat-window">
                        <div class="chat-window-header" id="chatWindowHeader" style="display: none;">
                            <div>
                                <h3 id="chatSessionTitle">Session</h3>
                                <div class="chat-window-header-info" id="chatSessionInfo">Select a session to start chatting</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-outline" onclick="deleteCurrentChatSession()" title="Delete Chat">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button class="btn btn-outline" title="Assign Agent">
                                    <i class="fas fa-user-plus"></i> Assign
                                </button>
                            </div>
                        </div>
                        <div class="chat-messages-container" id="chatMessagesContainer">
                            <div class="no-session-selected">
                                <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <p>Select a session from the list to start chatting</p>
                            </div>
                            <div class="typing-indicator" id="adminTypingIndicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                        <div class="chat-input-area" id="chatInputArea" style="display: none;">
                            <div class="input-actions" style="display: flex; gap: 8px; padding: 0 20px 10px 20px;">
                                <button type="button" class="action-button" id="adminEmojiButton" title="Emoji" style="width: 36px; height: 36px; border: none; background: rgba(0, 0, 0, 0.05); color: var(--primary); border-radius: 50%; cursor: pointer; font-size: 16px; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(0, 6, 177, 0.1)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='rgba(0, 0, 0, 0.05)'; this.style.transform='scale(1)';"><i class="fas fa-smile"></i></button>
                                <button type="button" class="action-button" id="adminFileButton" title="Attach File" style="width: 36px; height: 36px; border: none; background: rgba(0, 0, 0, 0.05); color: var(--primary); border-radius: 50%; cursor: pointer; font-size: 16px; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(0, 6, 177, 0.1)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='rgba(0, 0, 0, 0.05)'; this.style.transform='scale(1)';"><i class="fas fa-paperclip"></i></button>
                                <input type="file" id="adminFileInput" style="display: none;" accept="image/*,application/pdf,.doc,.docx">
                            </div>
                            <form class="chat-input-form" id="chatInputForm" onsubmit="sendAgentMessage(event)">
                                <input 
                                    type="text" 
                                    class="chat-input-field" 
                                    id="agentMessageInput" 
                                    placeholder="Message" 
                                    autocomplete="off"
                                >
                                <button type="submit" class="chat-send-button" id="agentSendButton" title="Send">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                            <div id="adminEmojiPicker" class="emoji-picker" style="display: none; position: absolute; bottom: 80px; left: 20px; background: var(--bg-primary); border: 2px solid #CFB53B; border-radius: var(--radius); padding: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), 0 0 0 2px #0006B1; max-width: 300px; max-height: 200px; overflow-y: auto; z-index: 1000;">
                                <div class="emoji-grid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; font-size: 20px;">
                                    ðŸ˜€ ðŸ˜ƒ ðŸ˜„ ðŸ˜ ðŸ˜† ðŸ˜… ðŸ¤£ ðŸ˜‚ ðŸ™ƒ ðŸ˜‰ ðŸ˜Š ðŸ˜‡ ðŸ™‚ ðŸ˜‹ ðŸ˜Œ ðŸ˜ ðŸ¥° ðŸ˜˜ ðŸ˜— ðŸ˜™ ðŸ˜š ðŸ˜œ ðŸ˜ ðŸ˜› ðŸ¤‘ ðŸ¤— ðŸ¤“ ðŸ˜Ž ðŸ¤¡ ðŸ¤  ðŸ˜ ðŸ˜’ ðŸ˜ž ðŸ˜” ðŸ˜Ÿ ðŸ˜• ðŸ™ â˜¹ï¸ ðŸ˜£ ðŸ˜– ðŸ˜« ðŸ˜© ðŸ¥º ðŸ˜¢ ðŸ˜­ ðŸ˜¤ ðŸ˜  ðŸ˜¡ ðŸ¤¬ ðŸ¤¯ ðŸ˜³ ðŸ¥µ ðŸ¥¶ ðŸ˜± ðŸ˜¨ ðŸ˜° ðŸ˜¥ ðŸ˜“ ðŸ¤” ðŸ¤­ ðŸ¤« ðŸ¤¥ ðŸ˜¶ ðŸ˜ ðŸ˜‘ ðŸ˜¬ ðŸ™„ ðŸ˜¯ ðŸ˜¦ ðŸ˜§ ðŸ˜® ðŸ˜² ðŸ¥± ðŸ˜´ ðŸ¤¤ ðŸ˜ª ðŸ˜µ ðŸ¤ ðŸ¥´ ðŸ¤¢ ðŸ¤® ðŸ¤§ ðŸ˜· ðŸ¤’ ðŸ¤• ðŸ˜ˆ ðŸ‘¿ ðŸ‘¹ ðŸ‘º ðŸ’© ðŸ‘» ðŸ’€ â˜ ï¸ ðŸ‘½ ðŸ‘¾ ðŸ¤– ðŸŽƒ ðŸ˜º ðŸ˜¸ ðŸ˜¹ ðŸ˜» ðŸ˜¼ ðŸ˜½ ðŸ™€ ðŸ˜¿ ðŸ˜¾
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize variables
        let statusChart = null;
        let activityChart = null;
        let responseTimeChart = null;
        let performanceChart = null;

        let currentSessionId = null;
        let messagePollInterval = null;
        let isDarkMode = false;

        // Show/hide sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('mobile-open');
            mainContent.classList.toggle('expanded');
        }

        // Toggle dark mode
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const themeIcon = document.querySelector('.theme-toggle i');
            const root = document.documentElement;
            const body = document.body;
            
            // Save theme preference
            localStorage.setItem('darkMode', isDarkMode);
            
            if (isDarkMode) {
                // WhatsApp-style dark theme with proper opacity and rounded borders
                root.style.setProperty('--bg-primary', '#111B21');
                root.style.setProperty('--bg-secondary', '#0B141A');
                root.style.setProperty('--bg-tertiary', '#202C33');
                root.style.setProperty('--bg-quaternary', '#1F2937');
                root.style.setProperty('--text-primary', '#E9EDEF');
                root.style.setProperty('--text-secondary', '#D1D7DB');
                root.style.setProperty('--text-tertiary', '#8696A0');
                root.style.setProperty('--text-inverse', '#E9EDEF');
                root.style.setProperty('--border-light', 'rgba(134, 150, 160, 0.15)');
                root.style.setProperty('--border-medium', 'rgba(134, 150, 160, 0.25)');
                root.style.setProperty('--white', '#111B21');
                root.style.setProperty('--primary', '#25D366');
                root.style.setProperty('--primary-dark', '#20BA5A');
                root.style.setProperty('--primary-light', '#53BDEB');
                root.style.setProperty('--accent', '#53BDEB');
                root.style.setProperty('--radius', '8px');
                root.style.setProperty('--radius-lg', '12px');
                
                body.classList.add('dark-mode');
                body.classList.remove('light-mode');
                body.style.background = '#0B141A';
                body.style.color = '#E9EDEF';
                if (themeIcon) themeIcon.className = 'fas fa-sun';
            } else {
                // WhatsApp-style light theme
                root.style.setProperty('--bg-primary', '#FFFFFF');
                root.style.setProperty('--bg-secondary', '#F0F2F5');
                root.style.setProperty('--bg-tertiary', '#E9EDEF');
                root.style.setProperty('--bg-quaternary', '#F5F6F6');
                root.style.setProperty('--text-primary', '#111B21');
                root.style.setProperty('--text-secondary', '#54656F');
                root.style.setProperty('--text-tertiary', '#667781');
                root.style.setProperty('--text-inverse', '#FFFFFF');
                root.style.setProperty('--border-light', 'rgba(0, 0, 0, 0.08)');
                root.style.setProperty('--border-medium', 'rgba(0, 0, 0, 0.12)');
                root.style.setProperty('--white', '#FFFFFF');
                root.style.setProperty('--primary', '#25D366');
                root.style.setProperty('--primary-dark', '#20BA5A');
                root.style.setProperty('--primary-light', '#128C7E');
                root.style.setProperty('--accent', '#34B7F1');
                root.style.setProperty('--radius', '8px');
                root.style.setProperty('--radius-lg', '12px');
                root.style.setProperty('--radius-xl', '16px');
                
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                body.style.background = '#F0F2F5';
                body.style.color = '#111B21';
                if (themeIcon) themeIcon.className = 'fas fa-moon';
            }
        }
        
        // Load saved theme preference on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('darkMode');
            const themeIcon = document.querySelector('.theme-toggle i');
            const root = document.documentElement;
            const body = document.body;
            
            if (savedTheme === 'true') {
                isDarkMode = true;
                
                // Apply dark theme without toggling
                root.style.setProperty('--bg-primary', '#111B21');
                root.style.setProperty('--bg-secondary', '#0B141A');
                root.style.setProperty('--bg-tertiary', '#202C33');
                root.style.setProperty('--bg-quaternary', '#1F2937');
                root.style.setProperty('--text-primary', '#E9EDEF');
                root.style.setProperty('--text-secondary', '#D1D7DB');
                root.style.setProperty('--text-tertiary', '#8696A0');
                root.style.setProperty('--text-inverse', '#E9EDEF');
                root.style.setProperty('--border-light', 'rgba(134, 150, 160, 0.15)');
                root.style.setProperty('--border-medium', 'rgba(134, 150, 160, 0.25)');
                root.style.setProperty('--white', '#111B21');
                root.style.setProperty('--primary', '#25D366');
                root.style.setProperty('--primary-dark', '#20BA5A');
                root.style.setProperty('--primary-light', '#53BDEB');
                root.style.setProperty('--accent', '#53BDEB');
                
                body.classList.add('dark-mode');
                body.classList.remove('light-mode');
                body.style.background = '#0B141A';
                body.style.color = '#E9EDEF';
                if (themeIcon) themeIcon.className = 'fas fa-sun';
            } else {
                // Default to WhatsApp-style light mode
                isDarkMode = false;
                
                // Apply WhatsApp-style light theme
                root.style.setProperty('--bg-primary', '#FFFFFF');
                root.style.setProperty('--bg-secondary', '#F0F2F5');
                root.style.setProperty('--bg-tertiary', '#E9EDEF');
                root.style.setProperty('--bg-quaternary', '#F5F6F6');
                root.style.setProperty('--text-primary', '#111B21');
                root.style.setProperty('--text-secondary', '#54656F');
                root.style.setProperty('--text-tertiary', '#667781');
                root.style.setProperty('--text-inverse', '#FFFFFF');
                root.style.setProperty('--border-light', 'rgba(0, 0, 0, 0.08)');
                root.style.setProperty('--border-medium', 'rgba(0, 0, 0, 0.12)');
                root.style.setProperty('--white', '#FFFFFF');
                root.style.setProperty('--primary', '#25D366');
                root.style.setProperty('--primary-dark', '#20BA5A');
                root.style.setProperty('--primary-light', '#128C7E');
                root.style.setProperty('--accent', '#34B7F1');
                root.style.setProperty('--radius', '8px');
                root.style.setProperty('--radius-lg', '12px');
                root.style.setProperty('--radius-xl', '16px');
                
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                body.style.background = '#F0F2F5';
                body.style.color = '#111B21';
                if (themeIcon) themeIcon.className = 'fas fa-moon';
            }
        }

        // Page titles mapping
        const pageTitles = {
            'overview': { title: 'Dashboard Overview', subtitle: 'Monitor your AI chat assistant performance in real-time' },
            'livechat': { title: 'Live Chat', subtitle: 'Chat with customers in real-time' },
            'agentchat': { title: 'Agent Chat', subtitle: 'Internal communication between agents' },
            'sessions': { title: 'Chat Sessions', subtitle: 'View and manage all chat sessions' },
            'agents': { title: 'Agents', subtitle: 'Manage your support agents' },
            'analytics': { title: 'Analytics', subtitle: 'Detailed analytics and insights' },
            'embed': { title: 'Embed Widget', subtitle: 'Generate embed code to add the chat widget to your website' },
            'profile': { title: 'Profile Settings', subtitle: 'Manage your profile, security, and login history' }
        };

        // Show section with animation - Make it globally accessible
        window.showSection = function(section, clickedElement) {
            // Hide all sections
            document.querySelectorAll('[id$="Section"]').forEach(el => {
                el.style.display = 'none';
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.sidebar-nav a').forEach(el => {
                el.classList.remove('active');
            });
            
            // Add active class to clicked nav item
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update header title
            const pageInfo = pageTitles[section] || { title: 'Dashboard', subtitle: '' };
            const headerTitle = document.getElementById('pageTitle');
            const headerSubtitle = document.getElementById('pageSubtitle');
            if (headerTitle) headerTitle.textContent = pageInfo.title;
            if (headerSubtitle) headerSubtitle.textContent = pageInfo.subtitle;
            
            // Show selected section with animation
            const targetSection = document.getElementById(section + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.style.animation = 'fadeInUp 0.5s ease-out';
            }
            
            // Load section data
            if (section === 'overview') {
                loadDashboard();
            } else if (section === 'sessions') {
                loadSessions();
            } else if (section === 'agents') {
                loadAgents();
            } else if (section === 'analytics') {
                loadAnalytics();
            } else if (section === 'livechat') {
                loadActiveSessions();
            } else if (section === 'agentchat') {
                loadAgentChats();
            } else if (section === 'embed') {
                // Embed section doesn't need data loading
            } else if (section === 'profile') {
                loadUserProfile();
            }
            
            // Close sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const response = await fetch('/api/analytics/');
                const data = await response.json();
                
                if (response.ok) {
                    // Update stats with animation
                    animateValue('totalSessions', 0, data.total_sessions || 0, 1000);
                    animateValue('aiResolved', 0, data.ai_resolved || 0, 1000);
                    animateValue('escalations', 0, data.escalation_count || 0, 1000);
                    document.getElementById('avgRating').textContent = (data.average_rating || 0).toFixed(1);
                    
                    // Update change indicators
                    const totalChangeEl = document.querySelector('#totalSessions').parentElement.querySelector('.stat-card-change');
                    if (totalChangeEl && data.total_sessions_change) {
                        const isPositive = data.total_sessions_change >= 0;
                        totalChangeEl.innerHTML = `<i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i> ${Math.abs(data.total_sessions_change)}% from last period`;
                        totalChangeEl.classList.toggle('negative', !isPositive);
                    }
                    
                    // Load charts with real data
                    loadCharts(data);
                } else {
                    console.error('Error loading analytics:', data);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Animate value changes
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // Load charts with real data
        function loadCharts(analyticsData) {
            // Status distribution chart
            if (statusChart) statusChart.destroy();
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const statusData = analyticsData?.status_distribution || {};
            const statusLabels = Object.keys(statusData);
            const statusValues = Object.values(statusData);
            
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: statusLabels.length > 0 ? statusLabels : ['No Data'],
                    datasets: [{
                        data: statusValues.length > 0 ? statusValues : [1],
                        backgroundColor: [
                            '#10b981',
                            '#0006B1',
                            '#CFB53B',
                            '#ef4444',
                            '#6b7280'
                        ],
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                            }
                        }
                    }
                }
            });

            // Activity chart
            if (activityChart) activityChart.destroy();
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            const dailyData = analyticsData?.daily_activity || [];
            const activityLabels = dailyData.map(d => d.day || d.date);
            const activityValues = dailyData.map(d => d.count || 0);
            
            activityChart = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: activityLabels.length > 0 ? activityLabels : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Sessions',
                        data: activityValues.length > 0 ? activityValues : [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#0006B1',
                        backgroundColor: 'rgba(0, 6, 177, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Response time chart - removed hardcoded data
            // This chart can be populated with real agent response time data if needed
            const responseTimeCtx = document.getElementById('responseTimeChart');
            if (responseTimeCtx && responseTimeChart) {
                responseTimeChart.destroy();
                // For now, show empty state or remove this chart
                responseTimeCtx.parentElement.innerHTML = `
                    <h3><i class="fas fa-clock"></i> Response Times</h3>
                    <p style="text-align: center; color: var(--text-tertiary); padding: 40px;">Response time data will be displayed here</p>
                `;
            }

            // Performance chart - removed hardcoded data
            // This chart can be populated with real performance metrics if needed
            const performanceCtx = document.getElementById('performanceChart');
            if (performanceCtx && performanceChart) {
                performanceChart.destroy();
                // For now, show empty state or remove this chart
                performanceCtx.parentElement.innerHTML = `
                    <h3><i class="fas fa-chart-pie"></i> Performance Metrics</h3>
                    <p style="text-align: center; color: var(--text-tertiary); padding: 40px;">Performance metrics will be displayed here</p>
                `;
            }
        }

        // Load sessions data
        async function loadSessions() {
            document.getElementById('sessionsLoading').style.display = 'block';
            document.getElementById('sessionsTable').style.display = 'none';
            
            try {
                const response = await fetch('/api/sessions/');
                const data = await response.json();
                
                const tbody = document.getElementById('sessionsTableBody');
                tbody.innerHTML = '';
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(session => {
                        const row = document.createElement('tr');
                        const messageCount = session.message_count || 0;
                        const agentName = session.assigned_agent ? 
                            (session.assigned_agent.username || 'Agent') : 
                            (session.status === 'resolved' && !session.assigned_agent ? 'AI' : 'N/A');
                        const statusClass = session.status.replace('_', '-');
                        
                        row.innerHTML = `
                            <td>${session.session_id.substring(0, 12)}...</td>
                            <td><span class="status-badge status-${statusClass}">${session.status}</span></td>
                            <td>${agentName}</td>
                            <td>${messageCount}</td>
                            <td>${new Date(session.created_at).toLocaleDateString()}</td>
                            <td>${session.rating ? 'â­'.repeat(session.rating) : '-'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No sessions found</td></tr>';
                }

                document.getElementById('sessionsLoading').style.display = 'none';
                document.getElementById('sessionsTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('sessionsLoading').textContent = 'Error loading sessions';
            }
        }

        // Load agents data
        async function loadAgents() {
            document.getElementById('agentsLoading').style.display = 'block';
            document.getElementById('agentsTable').style.display = 'none';
            
            try {
                const response = await fetch('/api/agents/');
                const data = await response.json();
                
                const tbody = document.getElementById('agentsTableBody');
                tbody.innerHTML = '';
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(agent => {
                        const row = document.createElement('tr');
                        const isAvailable = agent.is_available !== false;
                        row.innerHTML = `
                            <td>${agent.user?.username || agent.id}</td>
                            <td><span class="status-badge ${isAvailable ? 'status-active' : 'status-closed'}">${isAvailable ? 'Available' : 'Offline'}</span></td>
                            <td>${agent.current_chats || 0}</td>
                            <td>${agent.total_chats_handled || 0}</td>
                            <td>${(agent.average_rating || 0).toFixed(1)}</td>
                            <td>
                                <button class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No agents found</td></tr>';
                }

                document.getElementById('agentsLoading').style.display = 'none';
                document.getElementById('agentsTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading agents:', error);
                document.getElementById('agentsLoading').textContent = 'Error loading agents';
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics/');
                const data = await response.json();
                
                if (response.ok) {
                document.getElementById('analyticsContent').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-title">Total Sessions</div>
                                <div class="stat-card-value">${(data.total_sessions || 0).toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-title">AI Resolved</div>
                                <div class="stat-card-value">${(data.ai_resolved || 0).toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-title">Agent Resolved</div>
                                <div class="stat-card-value">${(data.agent_resolved || 0).toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-title">Resolution Rate</div>
                                <div class="stat-card-value">${(data.resolution_rate || 0).toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-bar"></i> Monthly Performance</h3>
                            <canvas id="monthlyChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3><i class="fas fa-clock"></i> Peak Hours</h3>
                            <canvas id="peakHoursChart"></canvas>
                        </div>
                    </div>
                `;
                
                    // Initialize analytics charts with real data
                    initializeAnalyticsCharts(data);
                } else {
                    document.getElementById('analyticsContent').innerHTML = `
                        <div class="empty-state">
                            <p>Error loading analytics data</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('analyticsContent').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading analytics data</p>
                    </div>
                `;
            }
        }

        // Initialize analytics charts with real data
        function initializeAnalyticsCharts(analyticsData) {
            // Monthly performance chart
            const monthlyCtx = document.getElementById('monthlyChart');
            if (!monthlyCtx) return;
            
            const monthlyData = analyticsData?.monthly_performance || [];
            const monthlyLabels = monthlyData.map(m => m.month);
            const monthlyValues = monthlyData.map(m => m.count);
            
            new Chart(monthlyCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: monthlyLabels.length > 0 ? monthlyLabels : ['No Data'],
                    datasets: [{
                        label: 'Sessions',
                        data: monthlyValues.length > 0 ? monthlyValues : [0],
                        backgroundColor: 'rgba(30, 58, 138, 0.8)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Peak hours chart - show only significant hours (every 4 hours)
            const peakCtx = document.getElementById('peakHoursChart');
            if (!peakCtx) return;
            
            const peakData = analyticsData?.peak_hours || [];
            // Filter to show every 4 hours for better readability
            const filteredPeakData = peakData.filter((_, index) => index % 4 === 0);
            const peakLabels = filteredPeakData.map(p => p.hour);
            const peakValues = filteredPeakData.map(p => p.count);
            
            new Chart(peakCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: peakLabels.length > 0 ? peakLabels : ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                    datasets: [{
                        label: 'Active Sessions',
                        data: peakValues.length > 0 ? peakValues : [0, 0, 0, 0, 0, 0],
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(30, 58, 138, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Live Chat Functions
        async function loadActiveSessions() {
            const sessionsListBody = document.getElementById('sessionsListBody');
            sessionsListBody.innerHTML = '<div class="loading">Loading active sessions...</div>';
            
            try {
                const response = await fetch('/api/sessions/?status=active&status=waiting_agent&status=agent_assigned');
                const data = await response.json();
                
                const sessions = data.results || [];
                
                if (sessions.length === 0) {
                    sessionsListBody.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"><i class="fas fa-comments"></i></div>
                            <p>No active sessions</p>
                        </div>
                    `;
                    return;
                }

                sessionsListBody.innerHTML = '';
                sessions.forEach(session => {
                    const sessionItem = document.createElement('div');
                    sessionItem.className = 'session-item';
                    sessionItem.onclick = () => openChatSession(session);
                    
                    // Get last message preview
                    const lastMessage = session.last_message || session.messages?.[session.messages.length - 1];
                    const preview = lastMessage?.content ? 
                        (lastMessage.content.length > 50 ? 
                         lastMessage.content.substring(0, 50) + '...' : 
                         lastMessage.content) : 
                        'No messages yet';
                    
                    const messageCount = session.message_count || session.messages?.length || 0;
                    const statusClass = session.status.replace('_', '-');
                    
                    sessionItem.innerHTML = `
                        <div class="session-item-header">
                            <span class="session-item-id">${session.session_id.substring(0, 12)}...</span>
                            <span class="session-item-time">${new Date(session.created_at).toLocaleTimeString()}</span>
                        </div>
                        <div class="session-item-preview">${preview}</div>
                        <div class="session-item-badge">
                            <span class="status-badge status-${statusClass}">${session.status}</span>
                            ${messageCount ? `<span style="font-size: 11px; color: var(--gray); margin-left: 8px;">${messageCount} msgs</span>` : ''}
                        </div>
                    `;
                    sessionsListBody.appendChild(sessionItem);
                });
            } catch (error) {
                console.error('Error loading active sessions:', error);
                sessionsListBody.innerHTML = '<div class="loading">Error loading sessions</div>';
            }
        }

        async function openChatSession(session) {
            currentSessionId = session.session_id || session.id;
            const sessionId = session.id || session.session_id;
            
            // Fetch full session details to get customer info
            try {
                // Try to get session by ID first, then by session_id
                let sessionResponse;
                if (session.id) {
                    sessionResponse = await fetch(`/api/sessions/${session.id}/`);
                } else {
                    // Find session by session_id
                    const sessionsResponse = await fetch('/api/sessions/');
                    const sessionsData = await sessionsResponse.json();
                    const foundSession = sessionsData.results?.find(s => s.session_id === currentSessionId);
                    if (foundSession && foundSession.id) {
                        sessionResponse = await fetch(`/api/sessions/${foundSession.id}/`);
                    }
                }
                
                if (sessionResponse && sessionResponse.ok) {
                    const fullSessionData = await sessionResponse.json();
                    // Store session data for use in loadChatMessages
                    window.currentSessionData = fullSessionData;
                    session = fullSessionData; // Update session with full data
                } else {
                    // Fallback to provided session data
                    window.currentSessionData = session;
                }
            } catch (error) {
                console.error('Error fetching session details:', error);
                // Fallback to provided session data
                window.currentSessionData = session;
            }
            
            // Update active session item
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.remove('active');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // Update chat window header with customer name
            const customerName = (session.customer_name || session.customer_email || 'Customer');
            document.getElementById('chatSessionTitle').textContent = `${customerName} - ${currentSessionId.substring(0, 8)}...`;
            const messageCount = session.message_count || session.messages?.length || 0;
            const createdDate = session.created_at || session.created;
            document.getElementById('chatSessionInfo').textContent = 
                `Status: ${session.status} | Messages: ${messageCount} | Created: ${new Date(createdDate).toLocaleString()}`;
            document.getElementById('chatWindowHeader').style.display = 'flex';
            document.getElementById('chatInputArea').style.display = 'block';
            
            // Load messages
            await loadChatMessages(currentSessionId, session);
            
            // Start polling for new messages
            if (messagePollInterval) {
                clearInterval(messagePollInterval);
            }
            messagePollInterval = setInterval(() => loadChatMessages(currentSessionId, session), 3000);
        }

        async function loadChatMessages(sessionId, sessionData = null) {
            try {
                const response = await fetch(`/api/chat/${sessionId}/messages/`);
                const data = await response.json();
                
                // Get session data if not provided
                if (!sessionData && window.currentSessionData) {
                    sessionData = window.currentSessionData;
                }
                
                const messagesContainer = document.getElementById('chatMessagesContainer');
                const existingMessages = messagesContainer.querySelectorAll('[data-message-id]');
                const existingIds = Array.from(existingMessages).map(el => el.getAttribute('data-message-id'));
                
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(message => {
                        // Skip if message already exists
                        if (existingIds.includes(String(message.id))) {
                            return;
                        }
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${message.message_type === 'user' ? 'user' : (message.message_type === 'agent' ? 'agent' : (message.message_type === 'system' ? 'ai' : 'ai'))}`;
                        messageDiv.setAttribute('data-message-id', message.id);
                        
                        // Add sender name for agent and user messages
                        let senderName = '';
                        if (message.message_type === 'agent' && message.sender_name) {
                            senderName = message.sender_name;
                        } else if (message.message_type === 'user') {
                            // Try to get customer name from session data or use default
                            senderName = (sessionData && sessionData.customer_name) || 
                                       (sessionData && sessionData.customer_email) || 
                                       'Customer';
                        } else if (message.message_type === 'system') {
                            senderName = 'System';
                        } else if (message.message_type === 'ai') {
                            senderName = 'AI Assistant';
                        }
                        
                        // Create sender label if we have a sender name (with profile picture)
                        if (senderName) {
                            const senderLabel = document.createElement('div');
                            senderLabel.className = 'chat-message-sender';
                            
                            // Add profile picture if available
                            const profilePictureUrl = message.sender_profile_picture || 
                                                     (message.message_type === 'agent' && message.sender_profile_picture);
                            if (profilePictureUrl) {
                                const profileImg = document.createElement('img');
                                profileImg.className = 'chat-message-sender-profile';
                                profileImg.src = profilePictureUrl;
                                profileImg.alt = senderName;
                                profileImg.onerror = function() {
                                    this.style.display = 'none';
                                };
                                senderLabel.appendChild(profileImg);
                            }
                            
                            const senderNameSpan = document.createElement('span');
                            senderNameSpan.textContent = senderName;
                            senderLabel.appendChild(senderNameSpan);
                            messageDiv.appendChild(senderLabel);
                        }
                        
                        // Create message wrapper for content and delete button
                        const messageWrapper = document.createElement('div');
                        messageWrapper.style.position = 'relative';
                        
                        const messageContent = document.createElement('div');
                        messageContent.className = 'chat-message-content';
                        messageContent.innerHTML = message.content.replace(/\n/g, '<br>');
                        
                        // Add delete button for agent/admin messages (only if not system message)
                        if (message.message_type !== 'system' && (message.message_type === 'agent' || message.message_type === 'user')) {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'chat-message-delete';
                            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                            deleteBtn.title = 'Delete message';
                            deleteBtn.onclick = function(e) {
                                e.stopPropagation();
                                if (confirm('Are you sure you want to delete this message?')) {
                                    deleteMessage(message.id, messageDiv);
                                }
                            };
                            messageContent.appendChild(deleteBtn);
                        }
                        
                        messageWrapper.appendChild(messageContent);
                        
                        // Handle attachments - especially voice messages
                        if (message.attachment_url || message.attachment) {
                            const attachmentUrl = message.attachment_url || message.attachment;
                            
                            // Only proceed if attachmentUrl is valid
                            if (attachmentUrl && attachmentUrl !== 'null' && attachmentUrl !== 'undefined' && !attachmentUrl.includes('${')) {
                                // Check if it's a voice message
                                if (message.attachment_type === 'voice' || attachmentUrl.match(/\.(webm|mp3|ogg|wav|m4a)$/i)) {
                                    // Create WhatsApp-like voice message player
                                    const voiceDiv = document.createElement('div');
                                    voiceDiv.className = 'voice-message-preview';
                                    voiceDiv.style.display = 'flex';
                                    voiceDiv.style.alignItems = 'center';
                                    voiceDiv.style.gap = '12px';
                                    voiceDiv.style.padding = '12px 16px';
                                    voiceDiv.style.background = message.message_type === 'user' ? '#0006B1' : '#CFB53B';
                                    voiceDiv.style.color = message.message_type === 'user' ? '#FFFFFF' : '#000000';
                                    voiceDiv.style.borderRadius = '12px';
                                    voiceDiv.style.cursor = 'pointer';
                                    voiceDiv.style.maxWidth = '75%';
                                    
                                    const playBtn = document.createElement('button');
                                    playBtn.className = 'voice-play-btn';
                                    playBtn.style.width = '36px';
                                    playBtn.style.height = '36px';
                                    playBtn.style.borderRadius = '50%';
                                    playBtn.style.background = message.message_type === 'user' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
                                    playBtn.style.border = 'none';
                                    playBtn.style.color = 'currentColor';
                                    playBtn.style.cursor = 'pointer';
                                    playBtn.style.display = 'flex';
                                    playBtn.style.alignItems = 'center';
                                    playBtn.style.justifyContent = 'center';
                                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                                    playBtn.onclick = function(e) {
                                        e.stopPropagation();
                                        playVoiceMessage(this, attachmentUrl, voiceDiv);
                                    };
                                    
                                    // Voice wave animation container
                                    const voiceWaveContainer = document.createElement('div');
                                    voiceWaveContainer.className = 'voice-wave-container';
                                    for (let i = 0; i < 5; i++) {
                                        const wave = document.createElement('div');
                                        wave.className = 'voice-wave';
                                        voiceWaveContainer.appendChild(wave);
                                    }
                                    
                                    const voiceInfo = document.createElement('div');
                                    voiceInfo.style.flex = '1';
                                    voiceInfo.style.display = 'flex';
                                    voiceInfo.style.flexDirection = 'column';
                                    voiceInfo.style.gap = '4px';
                                    
                                    const voiceDuration = document.createElement('div');
                                    voiceDuration.style.fontSize = '13px';
                                    voiceDuration.style.fontWeight = '500';
                                    voiceDuration.textContent = 'Voice message';
                                    
                                    const voiceTime = document.createElement('div');
                                    voiceTime.style.fontSize = '11px';
                                    voiceTime.style.opacity = '0.7';
                                    voiceTime.textContent = 'Tap to play';
                                    
                                    voiceInfo.appendChild(voiceDuration);
                                    voiceInfo.appendChild(voiceTime);
                                    
                                    voiceDiv.appendChild(playBtn);
                                    voiceDiv.appendChild(voiceWaveContainer);
                                    voiceDiv.appendChild(voiceInfo);
                                    
                                    messageContent.innerHTML = '';
                                    messageContent.appendChild(voiceDiv);
                                } else if (message.attachment_type && message.attachment_type.startsWith('image')) {
                                    const img = document.createElement('img');
                                    img.src = attachmentUrl;
                                    img.style.maxWidth = '200px';
                                    img.style.borderRadius = '8px';
                                    img.style.cursor = 'pointer';
                                    img.onerror = function() { this.style.display = 'none'; };
                                    img.onclick = () => window.open(attachmentUrl, '_blank');
                                    messageContent.appendChild(img);
                                } else {
                                    const link = document.createElement('a');
                                    link.href = attachmentUrl;
                                    link.textContent = 'ðŸ“Ž Attachment';
                                    link.target = '_blank';
                                    link.style.color = message.message_type === 'user' ? '#FFFFFF' : '#0006B1';
                                    messageContent.appendChild(link);
                                }
                            }
                        }
                        
                        // Append message wrapper first
                        messageDiv.appendChild(messageWrapper);
                        
                        // Create and append message time
                        const messageTime = document.createElement('div');
                        messageTime.className = 'chat-message-time';
                        messageTime.textContent = new Date(message.created_at).toLocaleTimeString();
                        messageDiv.appendChild(messageTime);
                        
                        // Add seen indicator with profile picture (Facebook-style) after message time
                        if (message.is_read && message.read_by_profile_picture) {
                            const seenIndicator = document.createElement('div');
                            seenIndicator.className = 'chat-message-seen';
                            
                            const seenLabel = document.createElement('span');
                            seenLabel.className = 'chat-message-seen-label';
                            seenLabel.textContent = 'Seen by';
                            seenIndicator.appendChild(seenLabel);
                            
                            const seenProfile = document.createElement('img');
                            seenProfile.className = 'chat-message-seen-profile';
                            seenProfile.src = message.read_by_profile_picture;
                            seenProfile.alt = message.read_by_name || 'Agent';
                            seenProfile.onerror = function() {
                                this.style.display = 'none';
                            };
                            seenIndicator.appendChild(seenProfile);
                            
                            messageDiv.appendChild(seenIndicator);
                        }
                        
                        // Append message to container
                        messagesContainer.appendChild(messageDiv);
                    });
                }
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Typing indicator for admin chat
        function showAdminTyping() {
            const typingIndicator = document.getElementById('adminTypingIndicator');
            if (typingIndicator) {
                typingIndicator.classList.add('active');
                const container = document.getElementById('chatMessagesContainer');
                container.appendChild(typingIndicator);
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function hideAdminTyping() {
            const typingIndicator = document.getElementById('adminTypingIndicator');
            if (typingIndicator) {
                typingIndicator.classList.remove('active');
            }
        }
        
        // Show typing when agent is typing and handle Enter key
        const agentMessageInput = document.getElementById('agentMessageInput');
        if (agentMessageInput) {
            // Enter key to send message
            agentMessageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.value.trim()) {
                        const fakeEvent = { preventDefault: () => {} };
                        sendAgentMessage(fakeEvent);
                    }
                }
            });
            
            let typingTimer = null;
            agentMessageInput.addEventListener('input', () => {
                // Could send typing event to server here
                // For now, we'll just handle it locally
            });
        }
        
        // Delete message function
        async function deleteMessage(messageId, messageElement) {
            try {
                const csrfToken = getCookie('csrftoken');
                const response = await fetch(`/api/messages/${messageId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken || ''
                    }
                });
                
                if (response.ok) {
                    messageElement.remove();
                } else {
                    const errorData = await response.json();
                    alert('Error deleting message: ' + (errorData.error || 'Please try again'));
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message. Please try again.');
            }
        }
        
        // Delete chat session function
        async function deleteChatSession(sessionId) {
            if (!confirm('Are you sure you want to delete this chat session? This action cannot be undone.')) {
                return;
            }
            
            try {
                const csrfToken = getCookie('csrftoken');
                // Find session by session_id
                const sessionsResponse = await fetch('/api/sessions/');
                const sessionsData = await sessionsResponse.json();
                const session = sessionsData.results?.find(s => s.session_id === sessionId);
                
                if (!session) {
                    alert('Session not found');
                    return;
                }
                
                const response = await fetch(`/api/sessions/${session.id}/delete_session/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken || ''
                    }
                });
                
                if (response.ok) {
                    alert('Chat session deleted successfully');
                    loadActiveSessions();
                    // Clear chat window
                    document.getElementById('chatWindowHeader').style.display = 'none';
                    document.getElementById('chatInputArea').style.display = 'none';
                    document.getElementById('chatMessagesContainer').innerHTML = `
                        <div class="no-session-selected">
                            <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">
                                <i class="fas fa-comments"></i>
                            </div>
                            <p>Select a session from the list to start chatting</p>
                        </div>
                    `;
                    currentSessionId = null;
                } else {
                    const errorData = await response.json();
                    alert('Error deleting session: ' + (errorData.error || 'Please try again'));
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('Error deleting session. Please try again.');
            }
        }
        
        // Delete current chat session
        function deleteCurrentChatSession() {
            if (!currentSessionId) {
                alert('No session selected');
                return;
            }
            deleteChatSession(currentSessionId);
        }

        async function sendAgentMessage(event) {
            event.preventDefault();
            
            if (!currentSessionId) {
                alert('Please select a session first');
                return;
            }
            
            const messageInput = document.getElementById('agentMessageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            const sendButton = document.getElementById('agentSendButton');
            sendButton.disabled = true;
            showAdminTyping();
            
            try {
                // Find session by ID
                const sessionsResponse = await fetch('/api/sessions/');
                const sessionsData = await sessionsResponse.json();
                const session = sessionsData.results?.find(s => s.session_id === currentSessionId);
                
                if (!session) {
                    alert('Session not found');
                    return;
                }
                
                // Send message via API
                const csrfToken = getCookie('csrftoken');
                const response = await fetch(`/api/sessions/${session.id}/send_message/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                    },
                    body: JSON.stringify({
                        content: message,
                        message_type: 'agent'
                    })
                });
                
                if (response.ok) {
                    messageInput.value = '';
                    hideAdminTyping();
                    // Reload messages to show the new one
                    await loadChatMessages(currentSessionId);
                } else {
                    hideAdminTyping();
                    const errorData = await response.json();
                    alert('Error sending message: ' + (errorData.error || 'Please try again'));
                }
                
            } catch (error) {
                hideAdminTyping();
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
            } finally {
                sendButton.disabled = false;
                messageInput.focus();
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Admin chat emoji picker and file upload
        const adminEmojiButton = document.getElementById('adminEmojiButton');
        const adminEmojiPicker = document.getElementById('adminEmojiPicker');
        const adminFileButton = document.getElementById('adminFileButton');
        const adminFileInput = document.getElementById('adminFileInput');
        if (adminEmojiButton && adminEmojiPicker) {
            const adminEmojiGrid = adminEmojiPicker.querySelector('.emoji-grid');
            adminEmojiGrid.innerHTML = adminEmojiGrid.textContent.split(' ').map(emoji => 
                emoji.trim() ? `<span style="cursor: pointer; padding: 5px; border-radius: 4px;">${emoji}</span>` : ''
            ).join('');
            
            adminEmojiButton.addEventListener('click', () => {
                adminEmojiPicker.style.display = adminEmojiPicker.style.display === 'none' ? 'block' : 'none';
            });
            
            adminEmojiGrid.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    const input = document.getElementById('agentMessageInput');
                    input.value += e.target.textContent;
                    input.focus();
                    adminEmojiPicker.style.display = 'none';
                }
            });
        }
        
        if (adminFileButton && adminFileInput) {
            adminFileButton.addEventListener('click', () => adminFileInput.click());
            adminFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && currentSessionId) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('session_id', currentSessionId);
                    const csrfToken = getCookie('csrftoken');
                    try {
                        const response = await fetch('/api/chat/upload/', {
                            method: 'POST',
                            headers: {...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})},
                            body: formData
                        });
                        if (response.ok) {
                            await loadChatMessages(currentSessionId);
                        }
                    } catch (error) {
                        console.error('Error uploading file:', error);
                    }
                    adminFileInput.value = '';
                }
            });
        }
        
        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (adminEmojiPicker && !adminEmojiPicker.contains(e.target) && e.target !== adminEmojiButton) {
                adminEmojiPicker.style.display = 'none';
            }
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/profile/');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('firstNameInput').value = data.first_name || '';
                    document.getElementById('lastNameInput').value = data.last_name || '';
                    document.getElementById('emailInput').value = data.email || '';
                    document.getElementById('phoneInput').value = data.phone_number || '';
                    document.getElementById('bioInput').value = data.bio || '';
                    
                    if (data.profile_picture_url) {
                        document.getElementById('profilePictureImg').src = data.profile_picture_url;
                        document.getElementById('profilePictureImg').style.display = 'block';
                        document.getElementById('profilePicturePlaceholder').style.display = 'none';
                    } else {
                        document.getElementById('profilePictureImg').style.display = 'none';
                        document.getElementById('profilePicturePlaceholder').style.display = 'flex';
                        document.getElementById('profilePicturePlaceholder').textContent = (data.first_name?.[0] || data.username?.[0] || 'A').toUpperCase();
                    }
                    
                    // Update header
                    document.getElementById('userName').textContent = data.first_name && data.last_name ? 
                        `${data.first_name} ${data.last_name}` : (data.username || 'Admin User');
                    document.getElementById('userRole').textContent = 'Administrator';
                    if (data.profile_picture_url) {
                        document.getElementById('userAvatar').style.backgroundImage = `url(${data.profile_picture_url})`;
                        document.getElementById('userAvatar').style.backgroundSize = 'cover';
                        document.getElementById('userAvatar').textContent = '';
                    } else {
                        document.getElementById('userAvatar').textContent = (data.first_name?.[0] || data.username?.[0] || 'A').toUpperCase();
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
            
            // Load login history
            loadLoginHistory();
        }

        // Load login history
        async function loadLoginHistory() {
            try {
                const response = await fetch('/api/profile/login-history/');
                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('loginHistoryBody');
                    tbody.innerHTML = '';
                    
                    if (data.length > 0) {
                        data.forEach(entry => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${new Date(entry.login_time).toLocaleString()}</td>
                                <td>${entry.ip_address}</td>
                                <td>${entry.device || 'Unknown'}</td>
                                <td>${entry.browser || 'Unknown'}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--gray);">No login history</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading login history:', error);
            }
        }

        // Update profile
        async function updateProfile() {
            const csrfToken = getCookie('csrftoken');
            try {
                const response = await fetch('/api/profile/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                    },
                    body: JSON.stringify({
                        first_name: document.getElementById('firstNameInput').value,
                        last_name: document.getElementById('lastNameInput').value,
                        email: document.getElementById('emailInput').value,
                        phone_number: document.getElementById('phoneInput').value,
                        bio: document.getElementById('bioInput').value
                    })
                });
                
                if (response.ok) {
                    alert('Profile updated successfully!');
                    loadUserProfile();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to update profile'));
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        }

        // Bot Configuration
        async function loadBotConfig() {
            try {
                const response = await fetch('/api/widget-config/');
                if (response.ok) {
                    const data = await response.json();
                    const botNameInput = document.getElementById('botName');
                    if (botNameInput && data.bot_name) {
                        botNameInput.value = data.bot_name;
                    }
                    const preview = document.getElementById('botProfileImagePreview');
                    const placeholder = document.getElementById('botProfileImagePlaceholder');
                    if (preview && placeholder && data.bot_profile_image) {
                        preview.src = data.bot_profile_image;
                        preview.style.display = 'block';
                        placeholder.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading bot config:', error);
            }
        }
        
        async function saveBotConfig() {
            const botNameInput = document.getElementById('botName');
            const botProfileImageInput = document.getElementById('botProfileImageInput');
            if (!botNameInput) return;
            
            const formData = new FormData();
            formData.append('bot_name', botNameInput.value);
            if (botProfileImageInput && botProfileImageInput.files.length > 0) {
                formData.append('bot_profile_image', botProfileImageInput.files[0]);
            }
            
            const csrfToken = getCookie('csrftoken');
            
            try {
                const response = await fetch('/api/widget-config/update/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken || ''
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert('Bot configuration saved successfully!');
                    if (data.bot_profile_image) {
                        const preview = document.getElementById('botProfileImagePreview');
                        const placeholder = document.getElementById('botProfileImagePlaceholder');
                        if (preview && placeholder) {
                            preview.src = data.bot_profile_image;
                            preview.style.display = 'block';
                            placeholder.style.display = 'none';
                        }
                    }
                } else {
                    const errorData = await response.json();
                    alert('Error saving bot configuration: ' + (errorData.error || 'Please try again.'));
                }
            } catch (error) {
                console.error('Error saving bot config:', error);
                alert('Error saving bot configuration. Please try again.');
            }
        }
        
        function handleBotProfileImageChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('botProfileImagePreview');
                    const placeholder = document.getElementById('botProfileImagePlaceholder');
                    if (preview && placeholder) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        placeholder.style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeBotProfileImage() {
            const preview = document.getElementById('botProfileImagePreview');
            const placeholder = document.getElementById('botProfileImagePlaceholder');
            const input = document.getElementById('botProfileImageInput');
            if (preview && placeholder && input) {
                preview.src = '';
                preview.style.display = 'none';
                placeholder.style.display = 'flex';
                input.value = '';
            }
        }

        // Embed Code Generator
        document.addEventListener('DOMContentLoaded', function() {
            loadBotConfig();
            
            const colorPicker = document.getElementById('widgetButtonColor');
            const colorText = document.getElementById('widgetButtonColorText');
            
            if (colorPicker && colorText) {
                colorPicker.addEventListener('input', function() {
                    colorText.value = this.value;
                });
                
                colorText.addEventListener('input', function() {
                    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                        colorPicker.value = this.value;
                    }
                });
            }
        });

        async function generateEmbedCode() {
            const name = document.getElementById('widgetName')?.value || 'Default Widget';
            const buttonColor = document.getElementById('widgetButtonColor')?.value || '#0006B1';
            const position = document.getElementById('widgetPosition')?.value || 'bottom-right';
            const width = document.getElementById('widgetWidth')?.value || 420;
            const height = document.getElementById('widgetHeight')?.value || 600;
            
            const csrfToken = getCookie('csrftoken');
            
            try {
                // First, update widget config if form fields exist
                if (document.getElementById('widgetName')) {
                    try {
                        await fetch('/api/widget-config/update/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                            },
                            body: JSON.stringify({
                                bot_name: name,
                                button_color: buttonColor,
                                button_position: position,
                                widget_width: parseInt(width),
                                widget_height: parseInt(height)
                            }),
                            credentials: 'same-origin' // Include cookies for session authentication
                        });
                    } catch (e) {
                        console.log('Config update failed, continuing with embed code generation');
                    }
                }
                
                // Get embed code from API
                // Use session authentication (cookies) - same pattern as other API calls like /api/analytics/
                const configResponse = await fetch('/api/embed-code/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin' // Include session cookies
                });
                
                if (!configResponse.ok) {
                    // Try to get error details
                    let errorMessage = configResponse.statusText;
                    try {
                        const errorData = await configResponse.json();
                        errorMessage = errorData.error || errorData.detail || errorMessage;
                    } catch (e) {
                        // If response is not JSON, use status text
                    }
                    throw new Error('Failed to generate embed code: ' + errorMessage);
                }
                
                const data = await configResponse.json();
                
                // Check for warnings
                const warningDiv = document.getElementById('embedWarning');
                if (data.warning || data.is_localhost) {
                    if (warningDiv) {
                        warningDiv.style.display = 'block';
                    }
                    // Also show alert for immediate attention
                    if (data.warning) {
                        alert(data.warning);
                    }
                } else {
                    if (warningDiv) {
                        warningDiv.style.display = 'none';
                    }
                }
                
                // Use embed code from API response
                let embedCode = '';
                
                if (data.embed_code) {
                    // Use embed code directly from API (it's already properly formatted)
                    embedCode = data.embed_code;
                } else if (data.embed_url) {
                    // Fallback: build simple embed code if API doesn't provide it
                    const embedUrl = data.embed_url;
                    const config = data.config || {};
                    const buttonColor = config.button_color || '#0006B1';
                    const widgetWidth = config.widget_width || 420;
                    const widgetHeight = config.widget_height || 600;
                    const position = config.button_position || 'bottom-right';
                    
                    // Position styles
                    const positionMap = {
                        'bottom-right': { bottom: '25px', right: '25px' },
                        'bottom-left': { bottom: '25px', left: '25px' },
                        'top-right': { top: '25px', right: '25px' },
                        'top-left': { top: '25px', left: '25px' }
                    };
                    const pos = positionMap[position] || positionMap['bottom-right'];
                    const posStyle = Object.keys(pos).map(k => k + ':' + pos[k]).join(';') + ';';
                    
                    // Build embed code using template literal for cleaner code
                    const svgIcon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" fill="white"/></svg>';
                    
                    embedCode = '<!-- Novyra Chat Widget -->\n' +
                        '<!-- Copy and paste this code before the closing </body> tag on your website -->\n' +
                        '<script>\n' +
                        '(function() {\n' +
                        '    if (window.novyraWidgetLoaded) return;\n' +
                        '    window.novyraWidgetLoaded = true;\n' +
                        '    var embedUrl = ' + JSON.stringify(embedUrl) + ';\n' +
                        '    var buttonColor = ' + JSON.stringify(buttonColor) + ';\n' +
                        '    var widgetWidth = ' + widgetWidth + ';\n' +
                        '    var widgetHeight = ' + widgetHeight + ';\n' +
                        '    var posStyle = ' + JSON.stringify(posStyle) + ';\n' +
                        '    var btn = document.createElement("button");\n' +
                        '    btn.id = "novyra-chat-btn";\n' +
                        '    btn.innerHTML = ' + JSON.stringify(svgIcon) + ';\n' +
                        '    btn.style.cssText = "position:fixed;width:60px;height:60px;border-radius:50%;background:" + buttonColor + ";color:white;border:2px solid #CFB53B;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:999999;display:flex;align-items:center;justify-content:center;transition:all 0.3s;" + posStyle;\n' +
                        '    var container = document.createElement("div");\n' +
                        '    container.id = "novyra-widget-container";\n' +
                        '    container.style.cssText = "position:fixed;width:" + widgetWidth + "px;height:" + widgetHeight + "px;max-width:calc(100vw - 40px);max-height:calc(100vh - 40px);z-index:1000000;display:none;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.3);overflow:hidden;" + posStyle;\n' +
                        '    var iframe = document.createElement("iframe");\n' +
                        '    iframe.src = embedUrl;\n' +
                        '    iframe.style.cssText = "width:100%;height:100%;border:none;display:block;";\n' +
                        '    iframe.allow = "microphone; camera";\n' +
                        '    iframe.setAttribute("frameborder", "0");\n' +
                        '    container.appendChild(iframe);\n' +
                        '    var isOpen = false;\n' +
                        '    btn.onclick = function() {\n' +
                        '        isOpen = !isOpen;\n' +
                        '        container.style.display = isOpen ? "block" : "none";\n' +
                        '        btn.style.display = isOpen ? "none" : "flex";\n' +
                        '    };\n' +
                        '    window.addEventListener("message", function(e) {\n' +
                        '        if (e.data && (e.data === "novyra-close-widget" || e.data.type === "novyra-close-widget")) {\n' +
                        '            isOpen = false;\n' +
                        '            container.style.display = "none";\n' +
                        '            btn.style.display = "flex";\n' +
                        '        }\n' +
                        '    });\n' +
                        '    document.body.appendChild(btn);\n' +
                        '    document.body.appendChild(container);\n' +
                        '})();\n' +
                        '<\/script>';
                } else {
                    embedCode = '<!-- Error: Could not generate embed code. Please try again. -->';
                }
                
                // Set embed code in textarea (it will be properly escaped by the browser)
                const textarea = document.getElementById('embedCodeTextarea');
                if (textarea) {
                    textarea.value = embedCode;
                } else {
                    console.error('Embed code textarea not found');
                }
                document.getElementById('embedCodeCard').style.display = 'block';
                document.getElementById('embedCodeCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                console.error('Error generating embed code:', error);
                alert('Error generating embed code: ' + error.message + '. Please try again.');
            }
        }

        function copyEmbedCode(e) {
            const textarea = document.getElementById('embedCodeTextarea');
            textarea.select();
            document.execCommand('copy');
            
            const button = (e && e.target) ? e.target.closest('button') : document.querySelector('#embedCodeCard button');
            if (button) {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.style.background = '#10b981';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            }
        }

        // Change password
        async function changePassword() {
            const csrfToken = getCookie('csrftoken');
            const currentPassword = document.getElementById('currentPasswordInput').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }
            
            try {
                const response = await fetch('/api/profile/change-password/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                    },
                    body: JSON.stringify({
                        old_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                
                if (response.ok) {
                    alert('Password changed successfully!');
                    document.getElementById('currentPasswordInput').value = '';
                    document.getElementById('newPasswordInput').value = '';
                    document.getElementById('confirmPasswordInput').value = '';
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to change password'));
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Error changing password. Please try again.');
            }
        }

        // Profile picture upload
        document.getElementById('profilePictureInput')?.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('profile_picture', file);
            
            try {
                const csrfToken = getCookie('csrftoken');
                const response = await fetch('/api/profile/picture/', {
                    method: 'POST',
                    headers: {
                        ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.profile_picture_url) {
                        document.getElementById('profilePictureImg').src = data.profile_picture_url;
                        document.getElementById('profilePictureImg').style.display = 'block';
                        document.getElementById('profilePicturePlaceholder').style.display = 'none';
                        document.getElementById('userAvatar').style.backgroundImage = `url(${data.profile_picture_url})`;
                        document.getElementById('userAvatar').style.backgroundSize = 'cover';
                        document.getElementById('userAvatar').textContent = '';
                    }
                    alert('Profile picture updated successfully!');
                } else {
                    alert('Error uploading profile picture');
                }
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                alert('Error uploading profile picture. Please try again.');
            }
        });

        // Play notification sound
        function playNotificationSound() {
            try {
                // Create audio context for notification sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800; // Notification tone
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Could not play notification sound:', error);
            }
        }
        
        // Load notifications with sound support
        let lastNotificationCount = 0;
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications/');
                if (response.ok) {
                    const data = await response.json();
                    const notificationList = document.getElementById('notificationList');
                    const badge = document.getElementById('notificationBadge');
                    
                    const unreadCount = data.unread_count || 0;
                    badge.textContent = unreadCount;
                    badge.style.display = (unreadCount > 0) ? 'flex' : 'none';
                    
                    // Play sound if new notifications
                    if (unreadCount > lastNotificationCount && lastNotificationCount > 0) {
                        playNotificationSound();
                        // Also show browser notification if permission granted
                        if (Notification.permission === 'granted') {
                            new Notification('Novyra AI - New Notification', {
                                body: `You have ${unreadCount} unread notification${unreadCount > 1 ? 's' : ''}`
                            });
                        }
                    }
                    lastNotificationCount = unreadCount;
                    
                    if (data.notifications && data.notifications.length > 0) {
                        notificationList.innerHTML = '';
                        data.notifications.forEach(notif => {
                            const item = document.createElement('div');
                            item.className = `notification-item ${notif.is_read ? '' : 'unread'}`;
                            item.onclick = () => markNotificationRead(notif.id);
                            item.innerHTML = `
                                <div class="notification-item-title">${notif.title}</div>
                                <div class="notification-item-message">${notif.message}</div>
                                <div class="notification-item-time">${new Date(notif.created_at).toLocaleString()}</div>
                            `;
                            notificationList.appendChild(item);
                        });
                    } else {
                        notificationList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray);">No notifications</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        // Request notification permission on load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Mark notification as read
        async function markNotificationRead(notificationId) {
            try {
                const csrfToken = getCookie('csrftoken');
                await fetch(`/api/notifications/${notificationId}/read/`, {
                    method: 'POST',
                    headers: {
                        ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
                    }
                });
                loadNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('active');
            if (dropdown.classList.contains('active')) {
                loadNotifications();
            }
        }

        // Toggle user dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.notification-bell')) {
                document.getElementById('notificationDropdown').classList.remove('active');
            }
            if (!event.target.closest('.user-profile')) {
                document.getElementById('userDropdown').classList.remove('active');
            }
        });

        // Enhanced file display in messages
        // Voice message player for admin chat
        let adminCurrentAudio = null;
        
        function playVoiceMessage(btn, audioUrl, voiceDiv) {
            const icon = btn.querySelector('i');
            const messageDiv = btn.closest('.chat-message');
            const voicePreview = voiceDiv || btn.closest('.voice-message-preview');
            
            if (icon.classList.contains('fa-play')) {
                // Stop any currently playing audio
                if (adminCurrentAudio) {
                    adminCurrentAudio.pause();
                    adminCurrentAudio = null;
                    // Reset all play buttons and wave animations
                    document.querySelectorAll('.voice-play-btn i').forEach(i => {
                        if (i.classList.contains('fa-pause')) {
                            i.classList.remove('fa-pause');
                            i.classList.add('fa-play');
                        }
                    });
                    document.querySelectorAll('.voice-message-preview').forEach(v => {
                        v.classList.remove('playing');
                    });
                }
                
                // Play audio
                if (audioUrl) {
                    try {
                        adminCurrentAudio = new Audio(audioUrl);
                        
                        // Add loading state
                        icon.classList.remove('fa-play');
                        icon.classList.add('fa-spinner', 'fa-spin');
                        
                        adminCurrentAudio.addEventListener('loadeddata', () => {
                            icon.classList.remove('fa-spinner', 'fa-spin');
                            icon.classList.add('fa-pause');
                            // Start wave animation
                            if (voicePreview) {
                                voicePreview.classList.add('playing');
                            }
                        });
                        
                        adminCurrentAudio.play().catch(error => {
                            console.error('Error playing audio:', error);
                            icon.classList.remove('fa-spinner', 'fa-spin', 'fa-pause');
                            icon.classList.add('fa-play');
                            if (voicePreview) {
                                voicePreview.classList.remove('playing');
                            }
                            alert('Unable to play voice message. Please check your internet connection.');
                        });
                        
                        adminCurrentAudio.onended = () => {
                            icon.classList.remove('fa-pause');
                            icon.classList.add('fa-play');
                            // Stop wave animation
                            if (voicePreview) {
                                voicePreview.classList.remove('playing');
                            }
                            adminCurrentAudio = null;
                        };
                        
                        adminCurrentAudio.onerror = (error) => {
                            console.error('Audio error:', error);
                            icon.classList.remove('fa-spinner', 'fa-spin', 'fa-pause');
                            icon.classList.add('fa-play');
                            // Stop wave animation
                            if (voicePreview) {
                                voicePreview.classList.remove('playing');
                            }
                            adminCurrentAudio = null;
                            alert('Error playing voice message. The file may be corrupted or unavailable.');
                        };
                    } catch (error) {
                        console.error('Error creating audio:', error);
                        icon.classList.remove('fa-spinner', 'fa-spin');
                        icon.classList.add('fa-play');
                    }
                }
            } else if (icon.classList.contains('fa-pause')) {
                // Pause audio
                if (adminCurrentAudio) {
                    adminCurrentAudio.pause();
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    // Stop wave animation
                    if (voicePreview) {
                        voicePreview.classList.remove('playing');
                    }
                }
            }
        }
        
        function createAttachmentDisplay(message) {
            if (!message.attachment_url && !message.attachment) return '';
            
            const attachmentUrl = message.attachment_url || message.attachment;
            
            // Validate attachmentUrl
            if (!attachmentUrl || attachmentUrl === 'null' || attachmentUrl === 'undefined' || attachmentUrl.includes('${')) {
                return '';
            }
            
            const attachmentType = message.attachment_type || 'document';
            
            // Check if it's a voice message
            if (attachmentType === 'voice' || attachmentUrl.match(/\.(webm|mp3|ogg|wav|m4a)$/i)) {
                let voiceHtml = '<div class="voice-message-preview" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #CFB53B; border-radius: var(--radius); cursor: pointer; max-width: 75%;">';
                voiceHtml += '<button class="voice-play-btn" onclick="playVoiceMessage(this, ' + JSON.stringify(attachmentUrl) + ')" style="width: 36px; height: 36px; border-radius: 50%; background: rgba(0, 0, 0, 0.1); border: none; color: currentColor; cursor: pointer; display: flex; align-items: center; justify-content: center;">';
                voiceHtml += '<i class="fas fa-play"></i>';
                voiceHtml += '</button>';
                voiceHtml += '<div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">';
                voiceHtml += '<div style="font-size: 13px; font-weight: 500;">Voice message</div>';
                voiceHtml += '<div style="font-size: 11px; opacity: 0.7;">Tap to play</div>';
                voiceHtml += '</div>';
                voiceHtml += '</div>';
                return voiceHtml;
            } else if (attachmentType && attachmentType.startsWith('image')) {
                let imgHtml = '<div class="attachment-container">';
                imgHtml += '<img src="' + attachmentUrl + '" alt="Attachment" class="attachment-image" ';
                imgHtml += 'onclick="window.open(' + JSON.stringify(attachmentUrl) + ', ';
                imgHtml += JSON.stringify('_blank') + ')" ';
                imgHtml += 'onerror="this.style.display=';
                imgHtml += JSON.stringify('none') + '">';
                imgHtml += '</div>';
                return imgHtml;
            } else {
                const fileName = attachmentUrl.split('/').pop() || 'Attachment';
                let linkHtml = '<div class="attachment-container">';
                linkHtml += '<a href="' + attachmentUrl + '" target="_blank" class="attachment-document">';
                linkHtml += '<div class="attachment-icon">ðŸ“Ž</div>';
                linkHtml += '<div>';
                linkHtml += '<div style="font-weight: 600;">' + fileName + '</div>';
                linkHtml += '<div style="font-size: 12px; color: var(--gray);">Click to download</div>';
                linkHtml += '</div>';
                linkHtml += '</a>';
                linkHtml += '</div>';
                return linkHtml;
            }
        }

        // Update loadChatMessages to use enhanced attachment display
        const originalLoadChatMessages = loadChatMessages;
        loadChatMessages = async function(sessionId) {
            try {
                const response = await fetch(`/api/chat/${sessionId}/messages/`);
                const data = await response.json();
                
                const messagesContainer = document.getElementById('chatMessagesContainer');
                const existingMessages = messagesContainer.querySelectorAll('[data-message-id]');
                const existingIds = Array.from(existingMessages).map(el => el.getAttribute('data-message-id'));
                
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(message => {
                        if (existingIds.includes(String(message.id))) {
                            return;
                        }
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${message.message_type === 'user' ? 'user' : (message.message_type === 'agent' ? 'agent' : 'ai')}`;
                        messageDiv.setAttribute('data-message-id', message.id);
                        
                        const messageContent = document.createElement('div');
                        messageContent.className = 'chat-message-content';
                        messageContent.innerHTML = message.content.replace(/\n/g, '<br>');
                        
                        // Use enhanced attachment display
                        if (message.attachment_url || message.attachment) {
                            messageContent.innerHTML += createAttachmentDisplay(message);
                        }
                        
                        const messageTime = document.createElement('div');
                        messageTime.className = 'chat-message-time';
                        messageTime.textContent = new Date(message.created_at).toLocaleTimeString();
                        
                        messageDiv.appendChild(messageContent);
                        messageDiv.appendChild(messageTime);
                        messagesContainer.appendChild(messageDiv);
                    });
                }
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        };

        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
        
        // Auto-refresh active sessions every 10 seconds when on live chat
        setInterval(() => {
            if (document.getElementById('livechatSection').style.display !== 'none') {
                loadActiveSessions();
            }
        }, 10000);

        // Load dashboard, user profile, and notifications on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme(); // Load saved theme preference first
            loadDashboard();
            loadUserProfile();
            loadNotifications();
            // Poll for new notifications every 30 seconds
            setInterval(loadNotifications, 30000);
        });
    </script>
</body>
</html>